{include file="common/head"/}
<style>
  

.layui-input-group .layui-input {
  flex: 1;
  border-radius: 0;
}

.layui-input-group .layui-btn {
  border-radius: 0;
}
</style>
<!-- ★ 改造：订单审核通知（未读 / 已读 分区显示） -->
<style>
    .notice-box {
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .notice-unread {
      background: #fff7e6; /* 未读：偏暖色 */
    }
    .notice-read {
      background: #f5f5f5; /* 已读：灰色 */
    }
    .notice-title {
      font-weight: bold;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .notice-list {
      max-height: 260px;
      overflow: auto;
      padding-right: 4px;
    }
    /* 【新增】已读按钮美化样式 */
    .btn-read {
      display: inline-block;
      padding: 4px 12px;
      font-size: 12px;
      line-height: 1.5;
      color: #52c41a;
      background-color: #f6ffed;
      border: 1px solid #b7eb8f;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      font-weight: 400;
    }
    .btn-read:hover {
      background-color: #d9f7be;
      border-color: #95de64;
      box-shadow: 0 2px 4px rgba(82, 196, 26, 0.15);
    }
    .btn-read:active {
      background-color: #b7eb8f;
      transform: scale(0.98);
    }
    /* 【新增】删除按钮样式 */
    .notif-del-btn {
      display: inline-block;
      padding: 4px 12px;
      font-size: 12px;
      line-height: 1.5;
      color: #ff4d4f;
      background-color: #fff1f0;
      border: 1px solid #ffccc7;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      font-weight: 400;
      margin-left: 8px;
    }
    .notif-del-btn:hover {
      background-color: #ffccc7;
      border-color: #ff7875;
      box-shadow: 0 2px 4px rgba(255, 77, 79, 0.15);
    }
    .notif-del-btn:active {
      background-color: #ffa39e;
      transform: scale(0.98);
    }
    /* 【新增】已读通知行容器样式 */
    .notice-item-read {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    /* 已读通知 - 消息文字区域 */
    .notice-item-read .msg-text {
      flex: 1 1 auto;
      min-width: 0;
      white-space: normal;
      word-break: break-all;
      overflow-wrap: anywhere;
      text-overflow: initial;
      overflow: visible;
      color: #666;
    }
    /* 已读通知 - 时间区域 */
    .notice-item-read .msg-time {
      flex: 0 0 auto;
      white-space: normal;
      word-break: break-all;
      text-overflow: initial;
      overflow: visible;
      color: #999;
      font-size: 12px;
      max-width: 180px;
    }
</style>
<link rel="stylesheet" type="text/css" href="/static/admin/css/admin.css" />

<div class="admin-main layui-anim layui-anim-upbit">

    <div class="layui-row ">
        <!-- 新增冲突查询 -->
        <div class="layui-row" style="margin-bottom: 20px;">
            <div class="layui-col-md12" style="text-align: left;">
                <form class="layui-form" action="{:url('client/conflict')}" method="get" style="display: inline-block;width:100%">
                    <div class="layui-inline layui-input-group" style="margin-right: 10px;width:92%">
                        <input type="text" name="keyword" placeholder="输入客户名称/手机号" autocomplete="off"
                            class="layui-input" style="width: 100%;">
                    </div>
                    
                    
                    
                    <button class="layui-btn layui-btn-normal" lay-submit style="width:7%" type="submit">
                        <i class="layui-icon layui-icon-search"></i> 冲突查询
                    </button>
                    
                    
                </form>
            </div>
        </div>

    </div>
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-sm6 layui-col-md4">
                    <div class="layui-card">
                        <!-- <div class="layui-card-header">
                            总线索
                            <span class="layui-badge layui-bg-blue layuiadmin-badge">周</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">
                            <p class="layuiadmin-big-font">{$cluesCount} 条</p>
                            <p>
                                总线索
                                <span class="layuiadmin-span-color">{$cluesCount} 条</span>
                            </p>
                        </div>
                    </div> -->
                    <div class="layui-card-header">
                            订单
                            <span class="layui-badge layui-bg-cyan layuiadmin-badge">月</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">
                            <p class="layuiadmin-big-font">{$orderCount} 个</p>
                            <p>
                                我的订单
                                <span class="layuiadmin-span-color">{$myOrderCount} 个</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="layui-col-sm6 layui-col-md4">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            我的客户
                            <span class="layui-badge layui-bg-cyan layuiadmin-badge">月</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">
                            <p class="layuiadmin-big-font">{$clientCount_month}</p>
                            <p>
                                成交客户
                                <span class="layuiadmin-span-color">{$clientCount_cj} 个</span>
                            </p>
                        </div>
                    </div>
                </div>


                <div class="layui-col-sm6 layui-col-md4">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            公海
                            <span class="layui-badge layui-bg-cyan layuiadmin-badge">月</span>
                            <!-- <span class="layui-badge layui-bg-green layuiadmin-badge">年</span> -->
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">

                            <p class="layuiadmin-big-font">{$liberumCount}</p>
                            <p>
                                总数据
                                <span class="layuiadmin-span-color">{$liberumCount_year} 条</span>
                            </p>
                        </div>
                    </div>
                </div>


                <!-- <div class="layui-col-sm6 layui-col-md3">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            成交
                            <span class="layui-badge layui-bg-orange layuiadmin-badge">月</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">

                            <p class="layuiadmin-big-font">0</p>
                            <p>
                                成交率
                                <span class="layuiadmin-span-color">100% <i class="layui-inline layui-icon layui-icon-user"></i></span>
                            </p>
                        </div>
                    </div>
                </div>-->
            </div>
        </div>



    </div>


    <div class="layui-row layui-col-space15">

        <div class="layui-col-md8">
            <div class="layui-row layui-col-space15">

                <div class="layui-col-md12">

                    <div class="layui-card">
                        <div class="layui-card-header">绩效月排行</div>
                        <div class="layui-card-body">
                            <dl class="layuiadmin-card-status">
                                <table class="layui-table">
                                    <colgroup>
                                        <col width="100">
                                        <col>
                                    </colgroup>
                                    <!-- //月度排名（名）、月目标（元）、已成交（元）、完成率（%）、已成交（单）、提成点（%） -->
                                    <tbody>
                                        <tr>
                                            <td>月度排名</td>
                                            <td>业务员</td>
                                            <td>已成交（元）</td>
                                            <td>成单率（%）</td>
                                            <td>已成交（单）</td>
                                            <td>每月客户</td>
                                        </tr>
                                        {volist name='userlist' id='vo' key="k" }
                                        <tr>
                                            <td>{$k}</td>
                                            <td>{$vo['username']}</td>
                                            <td>{$vo['money_month']}</td>
                                            <td>  {if condition="$vo.client_count_month > 0"}
        {:round($vo['number_month'] / $vo['client_count_month'] * 100, 2)}%
    {else}
        0.00%
    {/if}</td>
                                            <td>{$vo['number_month']}</td>
                                            <td>{$vo.client_count_month}</td>
                                        </tr>
                                        {/volist}
                                    </tbody>
                                </table>

                            </dl>
                        </div>
                    </div>


                </div>
            </div>
        </div>
        <div class="layui-col-md4">
            <div class="layui-card">
                <div class="layui-card-header">待办事项</div>
                <div class="layui-card-body layui-text">
                    <table class="layui-table">
                        <colgroup>
                            <col width="150">
                            <col>
                        </colgroup>
                        <tbody>

                            <tr>
                                <td>今日已跟进</td>
                                <td>
                                    {$today_count}
                                </td>
                            </tr>
                            <tr>
                                <td>未跟进个数</td>
                                <td>
                                    {$all_count}
                                </td>
                            </tr>
                            <tr>
                                <td>跟进率</td>
                                <td>
                                    {$genjinlv}%
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>




            <div class="layui-card">
                <div class="layui-card-header">
                    {$wenhou}
                    <i class="layui-icon layui-icon-tips" title="{:config('sys_name')}" lay-offset="5"></i>
                </div>
                <div class="layui-card-body layui-text layadmin-text">

                    <!-- 上面：未读通知（最多10条） -->
                    <div class="notice-box notice-unread">
                        <div class="notice-title">
                        <span>未读通知（最多10条）</span>
                        </div>
                    
                        <div class="notice-list">
                        {volist name='unreadNotifications' id='notice'}
                        <p class="notice-item notice-item-unread"
                            data-id="{$notice.id}"
                            data-type="{$notice.type}"
                            data-time="{$notice.create_time|date='m-d H:i'}"
                            data-msg="{$notice.message}"
                            style="margin: 5px 0; padding: 6px; border-left: 3px solid {if condition='$notice.type == 1'}green{else}red{/if}; display:flex; align-items:center; justify-content:space-between; gap:10px;">
                        
                            <span style="flex:1; min-width:0;">
                                <span style="color: {if condition='$notice.type == 1'}#5FB878{else}#FF5722{/if};">
                                    {$notice.message}
                                </span>
                                <span style="color: #999; font-size: 12px; margin-left: 10px;">
                                    ({$notice.create_time|date='m-d H:i'})
                                </span>
                            </span>
                        
                            <!-- ✅【新增】已读按钮 -->
                            <button type="button"
                                    class="btn-read notice-mark-read-btn"
                                    data-id="{$notice.id}">
                                已读
                            </button>
                        </p>
                        {/volist}
                            
                    
                        {if condition='empty($unreadNotifications)'}
                        <p style="color: #999; font-size: 12px;">暂无未读通知</p>
                        {/if}
                        </div>
                    </div>
  
                    <!-- 下面：已读通知（最多5条） -->
                    <div class="notice-box notice-read">
                        <div class="notice-title">
                        <span>已读通知（最多5条）</span>
                        </div>
                    
                        <div class="notice-list" style="max-height: 160px;">
                        {volist name='readNotifications' id='notice'}
                        <p class="notice-item-read" data-id="{$notice.id}" style="margin: 5px 0; padding: 6px; border-left: 3px solid #ccc;">
                            <span class="msg-text">
                            {$notice.message}
                            </span>
                            <span class="msg-time">
                            {if condition="!empty($notice.audit_time)"}
                            {$notice.audit_time|date='Y-m-d H:i:s'}
                            {elseif condition="!empty($notice.read_time)"}
                            {$notice.read_time|date='Y-m-d H:i:s'}
                            {else /}
                            {$notice.create_time|date='Y-m-d H:i:s'}
                            {/if}
                            </span>
                            <!-- 【新增】删除按钮 -->
                            <button type="button" class="notif-del-btn" data-id="{$notice.id}">删除</button>
                        </p>
                        {/volist}    
                    
                        {if condition='empty($readNotifications)'}
                        <p style="color: #999; font-size: 12px;">暂无已读通知</p>
                        {/if}
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="layui-row layui-col-space15">

        <div class="layui-col-md8">
            <div class="layui-row layui-col-space15">

                <div class="layui-col-md12">

                    <div class="layui-card">
                        <div class="layui-card-header">动态</div>
                        <div class="layui-card-body">
                            <dl class="layuiadmin-card-status">


                                {volist name='result' id='vo'}
                                <dd>
                                    <div class="layui-status-img"><a href="javascript:;">
                                            <img src="{$vo.avatar}"></a>
                                    </div>
                                    <div>
                                        <p>{$vo.username} <em style="color: red;margin-right: 5px">跟进</em> <a
                                                href="{:url('Client/dialogue')}?id={$vo.id}"> {$vo.kh_name}</a> </p>
                                        <p><strong style="color: burlywood;margin-right: 5px">跟进记录:
                                            </strong>{$vo.reply_msg}</p>
                                        <span>跟进时间：{$vo.create_date|date='Y-m-d H:i:s'}</span>
                                    </div>
                                </dd>
                                {/volist}

                            </dl>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>
{include file="common/foot"/}
<script>
    layui.use(['table','jquery','layer'], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var layer = layui.layer;
    
        // ========================= 【新增】轮询相关全局状态变量 =========================
        var notifyTimer = null;        // 轮询定时器
        var lastStamp = '';             // 上次的变化标识
        var failCount = 0;              // 连续失败次数
        var isPolling = false;          // 是否正在轮询中（防止并发请求）
    
        // ========================= 【新增】获取下一次轮询延迟时间（带退避策略） =========================
        function getNextDelay() {
            if (failCount === 0) {
                // 正常情况：8秒 ± 1秒随机抖动
                return 8000 + Math.floor(Math.random() * 2000) - 1000; // 7000-9000ms
            } else if (failCount === 1) {
                return 15000; // 15秒
            } else if (failCount === 2) {
                return 30000; // 30秒
            } else {
                return 60000; // 60秒（failCount >= 3）
            }
        }
    
        // ========================= 【新增】加载通知列表并渲染到DOM =========================
        function loadNotificationsAndRender() {
            $.ajax({
                url: "{:url('Index/getNotifications')}?_t=" + Date.now(),
                type: "GET",
                dataType: "json",
                cache: false,
                success: function (res) {
                    if (!res || res.code != 1 || !res.data) {
                        console.warn('获取通知列表失败:', res ? res.msg : '未知错误');
                        return;
                    }
    
                    var unreadList = res.data.unread || [];
                    var readList = res.data.read || [];
    
                    // 渲染未读通知
                    var $unreadList = $('.notice-unread .notice-list').first();
                    $unreadList.empty();
    
                    if (unreadList.length === 0) {
                        $unreadList.append('<p style="color: #999; font-size: 12px;">暂无未读通知</p>');
                    } else {
                        unreadList.forEach(function(notice) {
                            var typeColor = notice.type == 1 ? '#5FB878' : '#FF5722';
                            var borderColor = notice.type == 1 ? 'green' : 'red';
                            var createTime = notice.create_time || '';
                            // 格式化时间：如果是完整格式则提取 m-d H:i，否则直接使用
                            var timeText = '';
                            if (createTime.match(/^\d{4}-\d{2}-\d{2}/)) {
                                timeText = createTime.substring(5, 16); // Y-m-d H:i:s -> m-d H:i
                            } else {
                                timeText = createTime;
                            }
    
                            var html = '<p class="notice-item notice-item-unread" ' +
                                'data-id="' + escapeHtml(notice.id) + '" ' +
                                'data-type="' + escapeHtml(notice.type) + '" ' +
                                'data-time="' + escapeHtml(timeText) + '" ' +
                                'data-msg="' + escapeHtml(notice.message) + '" ' +
                                'style="margin: 5px 0; padding: 6px; border-left: 3px solid ' + borderColor + '; display:flex; align-items:center; justify-content:space-between; gap:10px;">' +
                                '<span style="flex:1; min-width:0;">' +
                                '<span style="color: ' + typeColor + ';">' + escapeHtml(notice.message) + '</span>' +
                                '<span style="color: #999; font-size: 12px; margin-left: 10px;">(' + escapeHtml(timeText) + ')</span>' +
                                '</span>' +
                                '<button type="button" class="btn-read notice-mark-read-btn" data-id="' + escapeHtml(notice.id) + '">已读</button>' +
                                '</p>';
                            $unreadList.append(html);
                        });
                    }
    
                    // 渲染已读通知
                    var $readList = $('.notice-read .notice-list').first();
                    $readList.empty();
    
                    if (readList.length === 0) {
                        $readList.append('<p style="color: #999; font-size: 12px;">暂无已读通知</p>');
                    } else {
                        readList.forEach(function(notice) {
                            var time = '';
                            if (notice.read_time) {
                                time = formatDateTime(notice.read_time);
                            } else if (notice.audit_time) {
                                time = formatDateTime(notice.audit_time);
                            } else if (notice.create_time) {
                                time = formatDateTime(notice.create_time);
                            }
    
                            var html = '<p class="notice-item-read" data-id="' + escapeHtml(notice.id) + '" ' +
                                'style="margin: 5px 0; padding: 6px; border-left: 3px solid #ccc;">' +
                                '<span class="msg-text">' + escapeHtml(notice.message) + '</span>' +
                                '<span class="msg-time">' + escapeHtml(time) + '</span>' +
                                '<button type="button" class="notif-del-btn" data-id="' + escapeHtml(notice.id) + '">删除</button>' +
                                '</p>';
                            $readList.append(html);
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.warn('加载通知列表网络错误:', error);
                }
            });
        }
    
        // ========================= 【新增】轮询核心函数：执行一次心跳检测 =========================
        function pollOnce() {
            // 如果页面不可见，直接返回，不安排下一次
            if (document.visibilityState !== 'visible') {
                return;
            }
    
            // 防止并发请求
            if (isPolling === true) {
                return;
            }
    
            isPolling = true;
    
            $.ajax({
                url: "{:url('Index/notifyHeartbeat')}?_t=" + Date.now(),
                type: "GET",
                dataType: "json",
                cache: false,
                success: function (res) {
                    isPolling = false;
    
                    // 检查登录状态
                    if (!res || res.code != 1) {
                        // 未登录或其他错误，停止轮询
                        if (res && res.code == 0 && res.msg && res.msg.indexOf('未登录') !== -1) {
                            stopNotifyPolling();
                            return;
                        }
                        // 其他错误，增加失败计数并安排下一次
                        failCount++;
                        scheduleNextPoll();
                        return;
                    }
    
                    var data = res.data || {};
                    var currentStamp = data.stamp || '';
    
                    // 如果 stamp 与上次相同，说明没有变化，只安排下一次轮询
                    if (currentStamp === lastStamp) {
                        failCount = 0; // 重置失败计数
                        scheduleNextPoll();
                        return;
                    }
    
                    // stamp 不同，说明有变化，拉取完整列表并刷新DOM
                    lastStamp = currentStamp;
                    failCount = 0; // 重置失败计数
                    loadNotificationsAndRender();
    
                    // 刷新后安排下一次轮询
                    scheduleNextPoll();
                },
                error: function(xhr, status, error) {
                    isPolling = false;
                    failCount++;
                    console.warn('轮询心跳请求失败:', error);
                    scheduleNextPoll();
                }
            });
        }
    
        // ========================= 【新增】安排下一次轮询 =========================
        function scheduleNextPoll() {
            // 如果页面不可见，不安排下一次
            if (document.visibilityState !== 'visible') {
                return;
            }
    
            // 清除之前的定时器
            if (notifyTimer !== null) {
                clearTimeout(notifyTimer);
                notifyTimer = null;
            }
    
            // 计算延迟时间
            var delay = getNextDelay();
    
            // 安排下一次轮询
            notifyTimer = setTimeout(function() {
                pollOnce();
            }, delay);
        }
    
        // ========================= 【新增】启动轮询 =========================
        function startNotifyPolling() {
            // 先停止之前的轮询
            stopNotifyPolling();
            // 立即触发一次
            pollOnce();
        }
    
        // ========================= 【新增】停止轮询 =========================
        function stopNotifyPolling() {
            if (notifyTimer !== null) {
                clearTimeout(notifyTimer);
                notifyTimer = null;
            }
            isPolling = false;
        }
    
        // ========================= 【新增】监听页面可见性变化 =========================
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                // 页面切到后台，立即停止轮询
                stopNotifyPolling();
            } else if (document.visibilityState === 'visible') {
                // 页面切回前台，立刻触发一次刷新
                startNotifyPolling();
            }
        });
    
        // ========================= 【新增】页面卸载时停止轮询 =========================
        window.addEventListener('beforeunload', function() {
            stopNotifyPolling();
        });
    
        // ========================= 【新增】页面初始化时启动轮询 =========================
        // 在 layui ready 后启动
        startNotifyPolling();
    
        // ✅【新增】点击"已读"
        $(document).on('click', '.notice-mark-read-btn', function () {
            var id = $(this).data('id');
            var $item = $(this).closest('.notice-item');
            var $btn = $(this);
    
            // 防止重复点
            if ($btn.data('loading')) return;
            $btn.data('loading', 1).text('处理中...');
    
            $.ajax({
                url: "{:url('Index/markNotificationRead')}",
                type: "POST",
                dataType: "json",
                data: { id: id },
                success: function (res) {
                    // 【修改】判断改为 res.code == 1
                    if (!res || res.code != 1) {
                        layer.msg((res && res.msg) ? res.msg : '标记已读失败');
                        $btn.data('loading', 0).text('已读');
                        return;
                    }
    
                    // 【修改】使用后端返回的 data 来渲染已读项（不再依赖 data-msg/data-time）
                    var d = res.data || {};
                    var msg = d.message || '';
                    // 优先使用 read_time，否则使用 create_time，格式化为完整时间
                    var time = '';
                    if (d.read_time) {
                        time = formatDateTime(d.read_time);
                    } else if (d.audit_time) {
                        time = formatDateTime(d.audit_time);
                    } else if (d.create_time) {
                        time = formatDateTime(d.create_time);
                    } else if (d.time_text) {
                        // 兼容旧格式，但尝试转换为完整时间
                        time = formatDateTime(d.time_text);
                    }
                    var readHtml =
                        '<p class="notice-item notice-item-read" data-id="'+d.id+'" ' +
                        'style="margin: 5px 0; padding: 6px; border-left: 3px solid #ccc;">' +
                        '  <span class="msg-text">'+ escapeHtml(msg) +'</span>' +
                        '  <span class="msg-time">' + escapeHtml(time) + '</span>' +
                        '  <button type="button" class="notif-del-btn" data-id="'+d.id+'">删除</button>' +
                        '</p>';
    
                    // 已读列表容器（你的已读区域 .notice-read 里第一个 .notice-list）
                    var $readList = $('.notice-read .notice-list').first();
                    // 未读列表容器
                    var $unreadList = $('.notice-unread .notice-list').first();
    
                    // 【新增】如果"暂无已读通知"存在，先删掉
                    $readList.find('p:contains("暂无已读通知")').remove();
    
                    // 【新增】已读超 5 条时：优先按 deleted_ids 精准删除
                    if (d.deleted_ids && d.deleted_ids.length > 0) {
                        d.deleted_ids.forEach(function(deletedId) {
                            // 精准删除：找到对应的已读项并移除（但要排除当前点击的这条，避免误删）
                            if (deletedId != d.id) {
                                $readList.find('p.notice-item-read[data-id="' + deletedId + '"]').remove();
                            }
                        });
                    }
    
                    // 【新增】插入到已读最顶部
                    $readList.prepend(readHtml);
    
                    // 【新增】如果已读超过 5 条：前端也删掉最旧的（最后一条，作为兜底逻辑）
                    var $reads = $readList.find('p.notice-item-read');
                    if ($reads.length > 5) {
                        $reads.last().remove();
                    }
    
                    // 【新增】删除未读项本身
                    $item.remove();
    
                    // 【新增】如果未读区被移空了：自动插入"暂无未读通知"
                    var $unreadItems = $unreadList.find('p.notice-item-unread');
                    if ($unreadItems.length === 0) {
                        if ($unreadList.find('p:contains("暂无未读通知")').length === 0) {
                            $unreadList.append('<p style="color: #999; font-size: 12px;">暂无未读通知</p>');
                        }
                    }
    
                    // 【修改】点击后按钮文字"处理中..."结束后不用恢复，因为该条会被移走/删除
                    // 所以这里不需要恢复按钮状态
    
                    // 【修改】立即显示成功提示
                    layer.msg('已标记为已读');
                },
                error: function () {
                    layer.msg('网络异常，标记失败');
                    $btn.data('loading', 0).text('已读');
                }
            });
        });
    
        // ✅【新增】HTML 转义，避免消息里有特殊字符导致 DOM 错乱
        function escapeHtml(str){
            if (str === null || str === undefined) return '';
            return String(str)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
        }
        
        // ✅【新增】格式化日期时间函数
        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            // 如果是完整日期时间格式，直接返回
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                return dateStr;
            }
            // 如果是 m-d H:i 格式，转换为 Y-m-d H:i:s（需要年份）
            var now = new Date();
            var year = now.getFullYear();
            if (dateStr.match(/^\d{2}-\d{2} \d{2}:\d{2}$/)) {
                return year + '-' + dateStr + ':00';
            }
            return dateStr;
        }

        // ✅【新增】点击"删除"按钮
        $(document).on('click', '.notif-del-btn', function (e) {
            e.stopPropagation(); // 阻止事件冒泡，避免触发行点击
            
            var id = $(this).data('id');
            var $item = $(this).closest('.notice-item-read');
            var $btn = $(this);
            
            // 防止重复点击
            if ($btn.data('loading')) return;
            
            // 弹出确认框
            layer.confirm('确定删除这条已读通知吗？', {
                icon: 3,
                title: '提示'
            }, function(index) {
                // 确认删除
                $btn.data('loading', 1).text('删除中...');
                
                $.ajax({
                    url: "{:url('Index/deleteNotification')}",
                    type: "POST",
                    dataType: "json",
                    data: { id: id },
                    success: function (res) {
                        layer.close(index); // 关闭确认框
                        
                        if (!res || res.code != 1) {
                            layer.msg((res && res.msg) ? res.msg : '删除失败');
                            $btn.data('loading', 0).text('删除');
                            return;
                        }
                        
                        // 删除成功：移除该行
                        $item.remove();
                        layer.msg('删除成功');
                        
                        // 如果已读区被移空了：自动插入"暂无已读通知"
                        var $readList = $('.notice-read .notice-list').first();
                        var $readItems = $readList.find('p.notice-item-read');
                        if ($readItems.length === 0) {
                            if ($readList.find('p:contains("暂无已读通知")').length === 0) {
                                $readList.append('<p style="color: #999; font-size: 12px;">暂无已读通知</p>');
                            }
                        }
                    },
                    error: function () {
                        layer.close(index); // 关闭确认框
                        layer.msg('网络异常，删除失败');
                        $btn.data('loading', 0).text('删除');
                    }
                });
            });
        });
    });
    
    // 原来的函数保留
    function searchConflict() {
        var keyword = $('input[name="keyword"]').val();
        if (!keyword) {
            layer.msg('请输入查询关键词');
            return false;
        }
        window.location.href = "{:url('Client/conflict')}?keyword=" + encodeURIComponent(keyword);
        return false;
    }
</script>
    
</body>

</html>