<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')} 后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all" />
    <link rel="stylesheet" href="/static/common/css/font.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/select.css" media="all" />
    <script src="/js/jquery.min.js"></script>
    <script src="/static/admin/js/select.js"></script>
    <script src="/static/plugins/layui/layui.js"></script>
    <script src="/static/admin/js/xm-select.js"></script>
    <script src="/js/xlsx.bundle.js"></script>
    <style>
        .layui-form-pane .layui-form-label {
            width: 110px;
            padding: 8px 15px;
            height: 38px;
            line-height: 20px;
            text-align: left;
            background-color: #FBFBFB;
            box-sizing: border-box;
        }
        /* 将下拉中括号内的分类名称加粗显示 */
        .cat-bold { font-weight: bold; }
        /* =================== 修复：强制 LayUI 下拉选中值左对齐 =================== */
        body .layui-form-select .layui-select-title input.layui-input,
        body .layui-form-select .layui-select-title input.layui-input[readonly],
        body .layui-form-select .layui-select-title > input.layui-input.layui-unselect {
            text-align: left !important;
            text-indent: 0 !important;
            padding-left: 12px !important;
            padding-right: 12px !important;
        }
        /* 下拉面板里的文字左对齐 */
        body .layui-form-select dl dd,
        body .layui-form-select dl dt {
            text-align: left !important;
        }
        /* ====================================================================== */
        /* 微信沟通凭证多图显示样式 */
        .multi-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .preview-item {
            position: relative;
            width: 120px;
            height: 120px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            background: #f5f5f5;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: zoom-in;
        }
        .label-long {
            width: 200px !important;   /* 或 220px，看你整体布局 */
        }
    </style>
    
    <style>
        /* 强制 LayUI 下拉选择框选中项文本为黑色，背景/边框为默认颜色 */
        body .layui-form-select .layui-select-title input.layui-input,
        body .layui-form-select .layui-select-title input.layui-input[readonly],
        body .layui-form-select .layui-select-title input.layui-input.layui-unselect {
            color: #000000 !important;       /* 文本颜色改为黑色 */
            background-color: #FFFFFF !important;  /* 背景颜色改为白色 */
            border-color: #E6E6E6 !important;      /* 边框颜色改为默认的浅灰色 */
        }
        body .layui-form-select dl {
            background-color: #FFFFFF !important;  /* 下拉列表背景改为白色 */
            border: 1px solid #D2D2D2 !important;  /* 下拉列表边框改为默认浅灰色 */
        }
        body .layui-form-select dl dd,
        body .layui-form-select dl dt {
            color: #000000 !important;       /* 下拉选项文本改为黑色 */
            background-color: #FFFFFF !important;  /* 下拉选项背景改为白色 */
        }
    </style>
    <style id="readonly-override">
        /* 让不可编辑的输入与文本域灰化但可选择文字 */
        .layui-input[readonly],
        .layui-textarea[readonly]{
        background-color:#f5f5f5 !important;
        color:#666 !important;
        cursor:not-allowed !important;
        }

        /* 禁用的 select（LayUI 渲染后）整体灰化并禁止交互 */
        .layui-form-select.layui-disabled .layui-select-title input{
        background-color:#f5f5f5 !important;
        color:#666 !important;
        cursor:not-allowed !important;
        }
        .layui-form-select.layui-disabled,
        .layui-form-select.layui-disabled *{
        pointer-events:none !important;
        }

        /* 原生 select 被禁用时也灰化 */
        select[disabled]{
        background-color:#f5f5f5 !important;
        color:#666 !important;
        cursor:not-allowed !important;
        }

        /* xm-select 组件禁用的灰化与禁止交互 */
        .xm-select-disabled,
        .xm-select-disabled *{
        pointer-events:none !important;
        cursor:not-allowed !important;
        }
        .xm-select.xm-select-disabled{
        background:#f5f5f5 !important;
        color:#666 !important;
        }

        /* 禁用加减按钮/普通按钮（如果页面后续打开提交按钮可一并灰化） */
        button[disabled],
        .layui-btn-disabled{
        pointer-events:none !important;
        opacity:0.6 !important;
        cursor:not-allowed !important;
        }
    </style>

</head>
<body class="skin-{$Think.cookie.skin|default='0'}">
    <div class="admin-main layui-anim layui-anim-upbit">
        <form class="layui-form layui-form-pane" lay-filter="orderForm">
            <!-- 【修改】隐藏域：订单ID -->
            <input type="hidden" name="id" value="{$orderInfo.id}">
            <!-- 【修改】客户联系方式（与 edit.html 对齐，移除订单编号，调整顺序） -->
            <div class="layui-form-item">
                <label class="layui-form-label">联系方式<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="contact" name="contact" lay-verify="required" readonly
                           value="{$orderInfo.contact|htmlentities}" placeholder="请输入客户联系方式" class="layui-input">
                </div>
            </div>
            <!-- 【新增】省市选择（与 edit.html 对齐，使用下拉选择） -->
            <div class="layui-form-item">
                <label class="layui-form-label">所在省市<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <select name="province" id="province" lay-search disabled>
                                <option value="">请选择省份</option>
                                {if condition="!empty($orderInfo.province)"}
                                <option value="{$orderInfo.province|htmlentities}" selected>{$orderInfo.province|htmlentities}</option>
                                {/if}
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <select name="city" id="city" lay-search disabled>
                                <option value="">请选择城市</option>
                                {if condition="!empty($orderInfo.city)"}
                                <option value="{$orderInfo.city|htmlentities}" selected>{$orderInfo.city|htmlentities}</option>
                                {/if}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 【修改】收货地址（与 edit.html 对齐，改名为收货地址） -->
            <div class="layui-form-item">
                <label class="layui-form-label">收货地址<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <textarea id="country" name="country" placeholder="请输入发货详细地址" readonly
                              class="layui-textarea">{:htmlentities($orderInfo.country)}</textarea>
                </div>
            </div>
            <!-- 【新增】用户属性选择（与 edit.html 对齐） -->
            <div class="layui-form-item">
                <label class="layui-form-label">用户属性<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="customer_type_flag" id="customer_type_flag" lay-verify="required" disabled>
                        <option value="">请选择用户属性</option>
                        <option value="0" {if $orderInfo.customer_type_flag == 0}selected{/if}>公司</option>
                        <option value="1" {if $orderInfo.customer_type_flag == 1}selected{/if}>个人</option>
                    </select>
                </div>
            </div>
            <!-- 【修改】客户公司（与 edit.html 对齐，条件显示） -->
            <div class="layui-form-item" id="client_company_item" {if condition="$orderInfo.customer_type_flag == 1"}style="display: none;"{/if}>
                <label class="layui-form-label">客户公司<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="client_company" name="client_company" readonly
                           value="{$orderInfo.client_company|htmlentities}" placeholder="请输入客户公司" class="layui-input">
                </div>
            </div>
            <!-- 【修改】客户性质（与 edit.html 对齐） -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户性质<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="customer_type" id="customer_type" lay-verify="required" lay-search disabled>
                        <option value="">请选择客户性质</option>
                        {volist name='customer_type' id='vo'}
                        <option value="{$vo}" {if $vo == $orderInfo.customer_type}selected{/if}>{$vo}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 【新增】客户名称（详情页显示，edit.html 中通过联系方式自动获取，不单独显示） -->
            {if condition="!empty($orderInfo.cname)"}
            <div class="layui-form-item">
                <label class="layui-form-label">客户名称</label>
                <div class="layui-input-4">
                    <input type="text" id="cname" name="cname" readonly
                           value="{$orderInfo.cname|htmlentities}" placeholder="客户名称" class="layui-input">
                </div>
            </div>
            {/if}
            <!-- 【修改】客户负责人（与 edit.html 对齐） -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户负责人<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="pr_user" name="pr_user" lay-verify="required" readonly
                           value="{$orderInfo.pr_user|default=''}" class="layui-input">
                </div>
            </div>
            <!-- 【修改】询盘来源（与 edit.html 对齐，改为下拉） -->
            <div class="layui-form-item">
                <label class="layui-form-label">询盘来源<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="source" id="source" lay-search disabled>
                        <option value="">请选择询盘来源</option>
                        {volist name='sourceList' id='vo'}
                        <option value="{$vo|htmlentities}" {if $vo == $orderInfo.source}selected{/if}>{$vo|htmlentities}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 【修改】运营端口（与 edit.html 对齐，改为下拉） -->
            <div class="layui-form-item">
                <label class="layui-form-label">运营端口<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="source_port" id="source_port" lay-search disabled>
                        <option value="">请先选择询盘来源（选择后可搜索端口）</option>
                        {if condition="!empty($orderInfo.source_port)"}
                        <option value="{$orderInfo.source_port|htmlentities}" selected>{$orderInfo.source_port|htmlentities}</option>
                        {/if}
                    </select>
                </div>
            </div>
            <!-- 【修改】收款账户（与 edit.html 对齐） -->
            <div class="layui-form-item">
                <label class="layui-form-label">收款账户</label>
                <div class="layui-input-4">
                    <select name="bank_account" id="bank_account" lay-verify="required" lay-search disabled>
                        <option value="">请选择收款账户</option>
                        {volist name="accountList" id="acc"}
                        <option value="{$acc.id}" {if $acc.id == $orderInfo.bank_account}selected{/if}>{$acc.account|htmlentities}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 【修改】协同人（与 edit.html 对齐） -->
            <div class="layui-form-item">
                <label class="layui-form-label">协同人</label>
                <div class="layui-input-4">
                    <div id="collaboratorSelect"></div>
                </div>
            </div>
            <!-- 【修改】团队名称（与 edit.html 对齐） -->
            <div class="layui-form-item">
                <label class="layui-form-label">团队名称<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="team_name" id="team_name" lay-verify="required" lay-search disabled>
                        <option value="">请选择团队名称</option>
                        {volist name='teamList' id='vo'}
                        <option value="{$vo}" {if $vo == $orderInfo.team_name}selected{/if}>{$vo}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 【修改】成交时间（与 edit.html 对齐） -->
            <div class="layui-form-item">
                <label class="layui-form-label">成交时间<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="orderTime" name="order_time" value="{$orderInfo.order_time}" readonly
                           placeholder="请选择成交时间" class="layui-input" autocomplete="off">
                </div>
            </div>
            <!-- 【修改】产品明细表格（与 edit.html 对齐：单位改为 select，列名改为"利润"，添加操作列但隐藏） -->
            <div class="layui-form-item">
                <label class="layui-form-label">产品明细<span style="color:red;">*</span></label>
                <div class="layui-input-block">
                    <table id="product-table" class="layui-table">
                        <thead>
                            <tr>
                                <th>产品名称<span style="color:red;">*</span></th>
                                <th>产品经理<span style="color:red;">*</span></th>
                                <th>规格型号</th>
                                <th>单位<span style="color:red;">*</span></th>
                                <th>数量<span style="color:red;">*</span></th>
                                <th>销售单价<span style="color:red;">*</span></th>
                                <th>销售价合计<span style="color:red;">*</span></th>
                                <th>进价合计<span style="color:red;">*</span></th>
                                <th>利润<span style="color:red;">*</span></th>
                                <th>行备注</th>
                                <th style="display: none;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            {volist name="orderItems" id="item"}
                            <tr>
                                <td>
                                    <select name="product_name[]" lay-search lay-verify="required" disabled>
                                        <option value="">请选择产品名称</option>
                                        {volist name="productList" id="vo"}
                                        <option value="{$vo.id}" {if $vo.id == $item.product_id} selected {/if}>{$vo.product_name} ({$vo.category_name|default='无'})</option>
                                        {/volist}
                                    </select>
                                </td>
                                <td>
                                    <select name="product_manager[]" lay-search lay-verify="required" disabled>
                                        <option value="">请选择产品经理</option>
                                        {volist name="managerList" id="vo"}
                                        <option value="{$vo.admin_id}" {if $vo.admin_id == $item.manager_id} selected {/if}>{$vo.username}</option>
                                        {/volist}
                                    </select>
                                </td>
                                <td><input type="text" name="spec_model[]" value="{$item.spec_model|htmlentities}" class="layui-input" readonly></td>
                                <td>
                                    <select name="unit[]" lay-search lay-verify="required" disabled>
                                        <option value="">请选择单位</option>
                                        <option value="台" {if $item.unit == '台'}selected{/if}>台</option>
                                        <option value="套" {if $item.unit == '套'}selected{/if}>套</option>
                                        <option value="件" {if $item.unit == '件'}selected{/if}>件</option>
                                        <option value="个" {if $item.unit == '个'}selected{/if}>个</option>
                                        <option value="批" {if $item.unit == '批'}selected{/if}>批</option>
                                        <option value="根" {if $item.unit == '根'}selected{/if}>根</option>
                                        <option value="米" {if $item.unit == '米'}selected{/if}>米</option>
                                        <option value="吨" {if $item.unit == '吨'}selected{/if}>吨</option>
                                        <option value="箱" {if $item.unit == '箱'}selected{/if}>箱</option>
                                        <option value="包" {if $item.unit == '包'}selected{/if}>包</option>
                                        <option value="卷" {if $item.unit == '卷'}selected{/if}>卷</option>
                                        <option value="片" {if $item.unit == '片'}selected{/if}>片</option>
                                        <option value="块" {if $item.unit == '块'}selected{/if}>块</option>
                                        <option value="组" {if $item.unit == '组'}selected{/if}>组</option>
                                        <option value="束" {if $item.unit == '束'}selected{/if}>束</option>
                                        <option value="副" {if $item.unit == '副'}selected{/if}>副</option>
                                        <option value="双" {if $item.unit == '双'}selected{/if}>双</option>
                                        <option value="袋" {if $item.unit == '袋'}selected{/if}>袋</option>
                                        <option value="桶" {if $item.unit == '桶'}selected{/if}>桶</option>
                                        <option value="支" {if $item.unit == '支'}selected{/if}>支</option>
                                        <option value="kg" {if $item.unit == 'kg'}selected{/if}>kg</option>
                                        <option value="g" {if $item.unit == 'g'}selected{/if}>g</option>
                                        <option value="t" {if $item.unit == 't'}selected{/if}>t</option>
                                        <option value="千克" {if $item.unit == '千克'}selected{/if}>千克</option>
                                        <option value="公斤" {if $item.unit == '公斤'}selected{/if}>公斤</option>
                                        <option value="mm" {if $item.unit == 'mm'}selected{/if}>mm</option>
                                        <option value="cm" {if $item.unit == 'cm'}selected{/if}>cm</option>
                                        <option value="m" {if $item.unit == 'm'}selected{/if}>m</option>
                                        <option value="km" {if $item.unit == 'km'}selected{/if}>km</option>
                                        <option value="丝" {if $item.unit == '丝'}selected{/if}>丝</option>
                                        <option value="㎡" {if $item.unit == '㎡'}selected{/if}>㎡</option>
                                        <option value="cm²" {if $item.unit == 'cm²'}selected{/if}>cm²</option>
                                        <option value="mm²" {if $item.unit == 'mm²'}selected{/if}>mm²</option>
                                        <option value="L" {if $item.unit == 'L'}selected{/if}>L</option>
                                        <option value="m³" {if $item.unit == 'm³'}selected{/if}>m³</option>
                                        <option value="ml" {if $item.unit == 'ml'}selected{/if}>ml</option>
                                        <option value="套装" {if $item.unit == '套装'}selected{/if}>套装</option>
                                        <option value="车" {if $item.unit == '车'}selected{/if}>车</option>
                                        <option value="架" {if $item.unit == '架'}selected{/if}>架</option>
                                        <option value="头" {if $item.unit == '头'}selected{/if}>头</option>
                                        <option value="盘" {if $item.unit == '盘'}selected{/if}>盘</option>
                                        <option value="排" {if $item.unit == '排'}selected{/if}>排</option>
                                        <option value="平方" {if $item.unit == '平方'}selected{/if}>平方</option>
                                        <option value="立方" {if $item.unit == '立方'}selected{/if}>立方</option>
                                        <option value="节" {if $item.unit == '节'}selected{/if}>节</option>
                                        <option value="段" {if $item.unit == '段'}selected{/if}>段</option>
                                        <option value="条" {if $item.unit == '条'}selected{/if}>条</option>
                                        <option value="木箱" {if $item.unit == '木箱'}selected{/if}>木箱</option>
                                        <option value="纸箱" {if $item.unit == '纸箱'}selected{/if}>纸箱</option>
                                        <option value="托盘" {if $item.unit == '托盘'}selected{/if}>托盘</option>
                                        <option value="编织袋" {if $item.unit == '编织袋'}selected{/if}>编织袋</option>
                                        <option value="板" {if $item.unit == '板'}selected{/if}>板</option>
                                        <option value="柱" {if $item.unit == '柱'}selected{/if}>柱</option>
                                        <option value="瓶" {if $item.unit == '瓶'}selected{/if}>瓶</option>
                                        <option value="罐" {if $item.unit == '罐'}selected{/if}>罐</option>
                                    </select>
                                </td>
                                <td><input type="number" name="qty[]" value="{$item.qty}" class="layui-input" lay-verify="required|number" readonly></td>
                                <td><input type="number" name="unit_price[]" value="{$item.unit_price}" class="layui-input" lay-verify="required|number" step="0.01" readonly></td>
                                <td><input type="number" name="total_price[]" value="{$item.total_price}" class="layui-input" readonly></td>
                                <td><input type="number" name="purchase_price[]" value="{$item.purchase_price}" class="layui-input" lay-verify="required|number" step="0.01" readonly></td>
                                <td><input type="number" name="sub_profit[]" value="{$item.sub_profit}" class="layui-input" readonly></td>
                                <td><input type="text" name="item_remark[]" value="{$item.remark|htmlentities}" class="layui-input" readonly></td>
                                <td style="display: none;"><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row" disabled>删除</button></td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 【修改】费用和金额字段（与 edit.html 对齐） -->
            <div class="layui-form-item">
                <label class="layui-form-label">估算运费<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="shipping_cost" name="shipping_cost" lay-verify="required" readonly
                           value="{$orderInfo.shipping_cost|default='0'}" placeholder="请输入估算运费" class="layui-input">
                </div>
            </div>
            <!-- 【修改】票种性质（与 edit.html 对齐，改为下拉） -->
            <div class="layui-form-item">
                <label class="layui-form-label">票种性质<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="invoice_type" id="invoice_type" lay-verify="required" disabled>
                        <option value="">请选择票种性质</option>
                        <option value="普票" {if $orderInfo.invoice_type == '普票'}selected{/if}>普票</option>
                        <option value="专票" {if $orderInfo.invoice_type == '专票'}selected{/if}>专票</option>
                        <option value="不开票" {if $orderInfo.invoice_type == '不开票'}selected{/if}>不开票</option>
                    </select>
                </div>
            </div>
            <!-- 【修改】票种/票金额（与 edit.html 对齐，条件显示） -->
            <div class="layui-form-item" id="invoice_amount_item" {if condition="$orderInfo.invoice_type == '不开票'"}style="display: none;"{/if}>
                <label class="layui-form-label">票种/票金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="invoice_amount" name="invoice_amount" lay-verify="" readonly
                           value="{$orderInfo.invoice_amount|default='0'}" placeholder="请输入开票金额" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">税费金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="tax_amount" name="tax_amount" lay-verify="required" readonly
                           value="{$orderInfo.tax_amount|default='0'}" placeholder="请输入税费金额" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">调试费<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="debugging_cost" name="debugging_cost" lay-verify="required" readonly
                           value="{$orderInfo.debugging_cost|default='0'}" placeholder="请输入调试费" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">佣金<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="sales_commission" name="sales_commission" lay-verify="required" readonly
                           value="{$orderInfo.sales_commission|default='0'}" placeholder="请输入佣金" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">备注<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="split_remarks" name="split_remarks" lay-verify="required" readonly
                           value="{$orderInfo.split_remarks|default=''}" placeholder="请输入分成或其他情况" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">已收款金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="amount_received" name="amount_received" lay-verify="required" readonly
                           value="{$orderInfo.amount_received|default='0'}" placeholder="请输入已收款金额" class="layui-input">
                </div>
            </div>
            <!-- 【修改】订单金额、利润、利润率（与 edit.html 对齐） -->
            <div class="layui-form-item">
                <label class="layui-form-label">订单金额(￥)<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="money" name="money" lay-verify="number|required" readonly
                           value="{$orderInfo.money|default='0'}" placeholder="请输入订单总金额" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">利润(￥)<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="profit" name="profit" lay-verify="required" readonly
                           value="{$orderInfo.profit|default='0'}" placeholder="请输入利润" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">利润率(%)<span style="color:red;">*</span></label>
                <div class="layui-input-4" style="position: relative;">
                    <input type="text" id="margin_rate" name="margin_rate" lay-verify="required" readonly
                           value="{$orderInfo.margin_rate|default='0'}" placeholder="请输入利润率" class="layui-input">
                    <span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%);">%</span>
                </div>
            </div>
            <!-- 备注 -->
            <!-- <div class="layui-form-item">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-4">
                    <textarea name="remark" placeholder="请输入备注信息" class="layui-textarea">{:htmlentities($orderInfo.remark)}</textarea>
                </div>
            </div> -->
            <!-- 微信沟通及付款凭证（多图显示） -->
            {if condition="!empty($orderInfo.wechat_receipt_images) && count($orderInfo.wechat_receipt_images) > 0"}
            <div class="layui-form-item" id="wechat_receipt_item">
                <label class="layui-form-label label-long">微信沟通及付款凭证</label>
                <div class="layui-input-4">
                    <div id="wechat_receipt_preview_list" class="multi-preview-list">
                        {volist name="orderInfo.wechat_receipt_images" id="img"}
                        <div class="preview-item">
                            <img src="{$img.thumb|default=$img.full}" class="js-img-preview" data-full="{$img.full}" alt="微信沟通及付款凭证" style="width: 100%; height: 100%; object-fit: cover; cursor: zoom-in;">
                        </div>
                        {/volist}
                    </div>
                </div>
            </div>
            {/if}
            <!-- 询盘来源凭证 -->
            {if condition="!empty($orderInfo.inquiry_assign_image)"}
            <div class="layui-form-item" id="inquiry_assign_item">
                <label class="layui-form-label label-long">询盘来源凭证</label>
                <div class="layui-input-4">
                    <img src="{$orderInfo.inquiry_assign_image}" alt="询盘来源凭证" class="js-img-preview" style="max-width: 500px; max-height: 300px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                </div>
            </div>
            {/if}
            <!-- 创建人 -->
            <div class="layui-form-item">
                <label class="layui-form-label">创建人</label>
                <div class="layui-input-4">
                    <input type="text" name="at_user" value="{$orderInfo.at_user|default=''|htmlentities}" 
                           placeholder="创建人" class="layui-input" readonly>
                </div>
            </div>
            <!-- 创建时间 -->
            <div class="layui-form-item">
                <label class="layui-form-label">创建时间</label>
                <div class="layui-input-4">
                    <input type="text" name="create_time" value="{$orderInfo.create_time|default=''}" 
                           placeholder="创建时间" class="layui-input" readonly>
                </div>
            </div>
            <!-- 更新时间 -->
            <div class="layui-form-item">
                <label class="layui-form-label">更新时间</label>
                <div class="layui-input-4">
                    <input type="text" name="ut_time" value="{$orderInfo.ut_time|default=''}" 
                           placeholder="更新时间" class="layui-input" readonly>
                </div>
            </div>
            <!-- 提交按钮 -->
            <!-- <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="button" class="layui-btn" lay-submit lay-filter="submit">提交保存</button>
                </div>
            </div> -->
        </form>
    </div>
    {include file="common/foot"/}
    <script type="text/javascript">
        // 【删除】changeyewu 函数（详情页不需要自动获取客户信息）
        layui.use(['form', 'layer', 'laydate'], function () {
            var form = layui.form, layer = layui.layer, $ = layui.jquery, laydate = layui.laydate;
            // 【修改】成交时间选择器：详情页不初始化日期控件，防止弹窗
            // 详情页只显示日期值，不提供日期选择功能
            // laydate.render({
            //     elem: '#orderTime',
            //     type: 'datetime',
            //     format: 'yyyy-MM-dd HH:mm:ss'
            // });
            // 自定义验证规则：数值验证
            form.verify({
                number: function (value) {
                    if (!/^\d+(\.\d+)?$/.test(value)) {
                        return '请输入有效的数字';
                    }
                }
            });
            // 【修改】协同人多选下拉初始化（详情页：初始化后立即禁用，但保持显示已选值）
            var collaboratorData = {$collaboratorList|raw};
            // 获取当前订单的协同人ID列表
            var currentJpIds = [];
            {if condition="!empty($orderInfo.joint_person)"}
            var jpStr = '{$orderInfo.joint_person}';
            if (jpStr) {
                if (jpStr.trim().charAt(0) === '[') {
                    try {
                        currentJpIds = JSON.parse(jpStr);
                    } catch(e) {
                        currentJpIds = jpStr.split(',').filter(function(v) { return v !== ''; });
                    }
                } else {
                    currentJpIds = jpStr.split(',').filter(function(v) { return v !== ''; });
                }
            }
            {/if}
            // 初始化 xm-select，设置初始值
            var collaboratorSelectInstance = xmSelect.render({
                el: '#collaboratorSelect',
                name: 'joint_person',
                tips: '请选择协同人员',
                filterable: true,
                clickClose: false,
                initValue: currentJpIds.map(function(id) { return String(id); }),
                data: collaboratorData
            });
            // 立即禁用协同人组件
            setTimeout(function() {
                try {
                    if (collaboratorSelectInstance && collaboratorSelectInstance.update) {
                        collaboratorSelectInstance.update({ disabled: true });
                    }
                    $('#collaboratorSelect').addClass('xm-select-disabled');
                } catch(e) {
                    console.log('禁用协同人组件失败:', e);
                }
            }, 100);



            // 【修改】渲染表单（详情页：先渲染，再禁用）
            form.render('select');
            fixSelectAlign(); // 首次渲染后调整下拉框文本左对齐
            
            // 【新增】详情页只读逻辑：渲染后立即禁用所有 select
            setTimeout(function() {
                // 禁用所有 select（包括产品明细表格中的）
                $('select').each(function() {
                    $(this).attr('disabled', true);
                });
                // 重新渲染以应用禁用状态
                form.render('select');
                // 给渲染后的下拉容器加禁用样式
                $('.layui-form-select').addClass('layui-disabled');
                fixSelectAlign(); // 再次调整对齐
            }, 200);





            // 分类名加粗显示处理
            function boldCategory($select) {
                var $options = $select.next('.layui-form-select').find('dl dd');
                $options.each(function () {
                    var text = $(this).text();
                    var m = text.match(/^(.*)\s*\((.+)\)\s*$/);
                    if (m) {
                        $(this).html(m[1] + ' (<span class="cat-bold">' + m[2] + '</span>)');
                    }
                });
            }
            // 初始化时对已有的产品名称下拉选项应用加粗样式
            boldCategory($('select[name="product_name[]"]'));
            // 新增产品明细行
            var productOptions = $('select[name="product_name[]"]').first().html();
            var managerOptions = $('select[name="product_manager[]"]').first().html();
            // $('#addRow').on('click', function () {
            //     var $tbody = $('#productTableBody');
            //     var newRow = document.createElement('tr');
            //     newRow.innerHTML =
            //         '<td><select name="product_name[]" lay-search lay-verify="required">' + productOptions + '</select></td>' +
            //         '<td><select name="product_manager[]" lay-search lay-verify="required">' + managerOptions + '</select></td>' +
            //         '<td><input type="text" name="spec_model[]" class="layui-input"></td>' +
            //         '<td><input type="text" name="unit[]" class="layui-input"></td>' +
            //         '<td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>' +
            //         '<td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
            //         '<td><input type="number" name="total_price[]" class="layui-input" readonly></td>' +
            //         '<td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
            //         '<td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>' +
            //         '<td><input type="text" name="item_remark[]" class="layui-input"></td>' +
            //         '<td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>';
            //     $tbody.append(newRow);
            //     form.render('select');
            //     fixSelectAlign(); // 确保新行下拉框文本左对齐
            //     boldCategory($(newRow).find('select[name="product_name[]"]'));
            // });
            // // 删除产品行
            // $('#productTableBody').on('click', '.delete-row', function () {
            //     $(this).closest('tr').remove();
            //     updateTotals();  // 更新总计
            // });
            // 更新单行的销售合计和子项利润
            function updateRow($tr) {
                var qty = parseFloat($tr.find('input[name="qty[]"]').val()) || 0;
                var unitPrice = parseFloat($tr.find('input[name="unit_price[]"]').val()) || 0;
                var purchase = parseFloat($tr.find('input[name="purchase_price[]"]').val()) || 0;
                var total = qty * unitPrice;
                var profit = total - purchase;
                $tr.find('input[name="total_price[]"]').val(total.toFixed(2));
                $tr.find('input[name="sub_profit[]"]').val(profit.toFixed(2));
            }
            // 更新所有产品行的总金额和总利润
            function updateTotals() {
                var sumTotal = 0, sumProfit = 0;
                $('#productTableBody tr').each(function () {
                    var $tr = $(this);
                    var qty = parseFloat($tr.find('input[name="qty[]"]').val()) || 0;
                    var unitPrice = parseFloat($tr.find('input[name="unit_price[]"]').val()) || 0;
                    var purchase = parseFloat($tr.find('input[name="purchase_price[]"]').val()) || 0;
                    sumTotal += qty * unitPrice;
                    sumProfit += (qty * unitPrice) - purchase;
                });
                $('#money').val(sumTotal.toFixed(2));
                var shippingCost = parseFloat($('#shipping_cost').val()) || 0;
                var taxAmount   = parseFloat($('#tax_amount').val()) || 0;
                var debugging   = parseFloat($('#debugging_cost').val()) || 0;
                var commission  = parseFloat($('#sales_commission').val()) || 0;
                var finalProfit = sumProfit - shippingCost - taxAmount - debugging - commission;
                $('#profit').val(finalProfit.toFixed(2));
                var marginRate = (sumTotal > 0) ? (finalProfit / sumTotal) * 100 : 0;
                $('#margin_rate').val(marginRate.toFixed(2));
            }
            // 【删除】详情页不需要自动计算和表单提交逻辑
            // 页面初始时计算总计（仅用于显示，不绑定事件）
            updateTotals();
            // 工具函数：修正下拉框文本左对齐
            function fixSelectAlign(ctx) {
                var $ctx = ctx ? $(ctx) : $(document);
                $ctx.find('.layui-form-select .layui-select-title input.layui-input').each(function () {
                    this.style.setProperty('text-align', 'left', 'important');
                    this.style.setProperty('text-indent', '0px', 'important');
                    this.style.setProperty('padding-left', '12px', 'important');
                    this.style.setProperty('padding-right', '12px', 'important');
                });
            }
            // 将对齐修正函数暴露到全局，便于在其他异步回调中调用
            window.fixSelectAlign = fixSelectAlign;

            // 判断是否满足凭证豁免条件（返单 or 利润<2000）
            function isVoucherExempt() {
                // 判断询盘来源是否为"返单"
                var sourceValue = $('#source').val() || '';
                var sourceText = $('#source option:selected').text() || '';
                var isReturnOrder = (sourceValue === '返单' || sourceText === '返单');
                
                // 判断利润是否<2000
                var profit = parseFloat($('#profit').val()) || 0;
                var isLowProfit = profit < 2000;
                
                return isReturnOrder || isLowProfit;
            }
            
            // 根据豁免条件更新凭证展示块的显示/隐藏
            function updateVoucherUI() {
                var exempt = isVoucherExempt();
                
                if (exempt) {
                    // 豁免：隐藏两个凭证块
                    $('#wechat_receipt_item').hide();
                    $('#inquiry_assign_item').hide();
                } else {
                    // 非豁免：显示两个凭证块
                    $('#wechat_receipt_item').show();
                    $('#inquiry_assign_item').show();
                }
            }

            /**
             * 图片预览功能：点击图片打开预览（支持放大/缩小/重置/滚轮缩放/拖拽移动）
             * 关键修复：点右上角 X 关闭时，click 可能"穿透"到底下的 .js-img-preview 导致立刻又打开
             *          => 用 closeAt 时间戳做 350ms 忽略窗，彻底解决"关闭按钮失效"的错觉
             */

            // 全局：关闭后的短时间内，忽略下一次点击（防止点X穿透后又触发底层图片 click）
            window.__IMG_PREVIEW_CLOSE_AT__ = window.__IMG_PREVIEW_CLOSE_AT__ || 0;

            // 使用命名空间绑定，避免重复绑定（详情页所有图片预览）
            $(document).off('click.detailsPreview', '.js-img-preview').on('click.detailsPreview', '.js-img-preview', function(e) {
                // 如果刚关闭（比如 350ms 内），说明这是"点X关闭"导致的穿透 click，直接忽略
                if (Date.now() - window.__IMG_PREVIEW_CLOSE_AT__ < 350) {
                    return;
                }

                // 优先读取data-full属性（原图URL），如果没有则使用src（兼容旧数据）
                var imgSrc = $(this).data('full') || $(this).attr('src');
                if (!imgSrc) return;

                // 缩放参数
                var scale = 1;
                var minScale = 0.2;
                var maxScale = 6;

                // 位置（用于拖拽）
                var translateX = 0, translateY = 0;
                var isDragging = false;
                var startX = 0, startY = 0;

                function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

                function applyTransform() {
                    var $img = $('#previewZoomImg');
                    $img.css('transform', 'translate(' + translateX + 'px,' + translateY + 'px) scale(' + scale + ')');
                    $('#zoomRateText').text(Math.round(scale * 100) + '%');
                }

                function zoomBy(delta, centerX, centerY) {
                    var oldScale = scale;
                    scale = clamp(scale + delta, minScale, maxScale);

                    // 以鼠标点为中心缩放（体验更好）
                    if (centerX != null && centerY != null) {
                        translateX = translateX - centerX * (scale / oldScale - 1);
                        translateY = translateY - centerY * (scale / oldScale - 1);
                    }
                    applyTransform();
                }

                var html = ''
                    + '<div id="previewWrap" style="position:relative; width:100%; height:100%; background:#000;">'
                    + '  <div id="previewToolbar" style="position:absolute; top:12px; left:12px; z-index:9999; display:flex; gap:8px; align-items:center;">'
                    + '    <button type="button" class="layui-btn layui-btn-sm" id="btnZoomIn">放大 +</button>'
                    + '    <button type="button" class="layui-btn layui-btn-sm" id="btnZoomOut">缩小 -</button>'
                    + '    <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" id="btnZoomReset">重置</button>'
                    + '    <span id="zoomRateText" style="color:#fff; font-size:12px; margin-left:6px;">100%</span>'
                    + '  </div>'
                    + '  <div id="previewStage" style="position:absolute; inset:0; overflow:auto; padding:20px;">'
                    + '    <div id="previewCanvas" style="position:relative; min-width:100%; min-height:100%; display:flex; align-items:flex-start; justify-content:center;">'
                    + '      <img id="previewZoomImg" src="' + imgSrc + '" style="transform-origin: top center; max-width:none; user-select:none; cursor:grab;" />'
                    + '    </div>'
                    + '  </div>'
                    + '</div>';

                layer.open({
                    type: 1,
                    title: '图片预览（可放大缩小，滚轮缩放，拖拽移动）',
                    closeBtn: 1,
                    shadeClose: true,
                    area: ['90vw', '90vh'],
                    content: html,
                    success: function(layero) {
                        // 初始化
                        scale = 1; translateX = 0; translateY = 0;
                        applyTransform();

                        // 关键：关闭按钮点击阻止冒泡（防止穿透）
                        layero.find('.layui-layer-close').off('click.previewCloseFix').on('click.previewCloseFix', function(ev){
                            ev.stopPropagation();
                        });

                        // 按钮事件（先解绑再绑定，避免重复）
                        $('#btnZoomIn').off('click.preview').on('click.preview', function() { zoomBy(0.2); });
                        $('#btnZoomOut').off('click.preview').on('click.preview', function() { zoomBy(-0.2); });
                        $('#btnZoomReset').off('click.preview').on('click.preview', function() {
                            scale = 1; translateX = 0; translateY = 0;
                            applyTransform();
                        });

                        // 鼠标滚轮缩放（在预览区域内）
                        $('#previewStage').off('wheel.preview').on('wheel.preview', function(ev) {
                            ev.preventDefault();
                            var oe = ev.originalEvent || ev;
                            var delta = (oe.deltaY > 0) ? -0.12 : 0.12;

                            var rect = this.getBoundingClientRect();
                            var cx = (oe.clientX || 0) - rect.left;
                            var cy = (oe.clientY || 0) - rect.top;

                            zoomBy(delta, cx, cy);
                        });

                        // 拖拽移动（按住图片拖动）
                        $('#previewZoomImg').off('mousedown.preview').on('mousedown.preview', function(ev) {
                            isDragging = true;
                            startX = ev.clientX;
                            startY = ev.clientY;
                            $(this).css('cursor', 'grabbing');
                            ev.preventDefault();
                            ev.stopPropagation();
                        });

                        // 用命名空间绑定，避免影响别的页面逻辑
                        $(document)
                            .off('mousemove.previewDrag').on('mousemove.previewDrag', function(ev) {
                                if (!isDragging) return;
                                var dx = ev.clientX - startX;
                                var dy = ev.clientY - startY;
                                startX = ev.clientX;
                                startY = ev.clientY;
                                translateX += dx;
                                translateY += dy;
                                applyTransform();
                            })
                            .off('mouseup.previewDrag').on('mouseup.previewDrag', function() {
                                if (!isDragging) return;
                                isDragging = false;
                                $('#previewZoomImg').css('cursor', 'grab');
                            });
                    },
                    end: function() {
                        // 记录关闭时间：防止点右上角 X 时 click 穿透到底下图片又触发打开
                        window.__IMG_PREVIEW_CLOSE_AT__ = Date.now();

                        // 清理拖拽事件
                        $(document).off('mousemove.previewDrag mouseup.previewDrag');
                    }
                });
            });


            // 打印按钮事件（仅超级管理员可见）
            $('#printBtn').on('click', function() {
                window.print();
            });

            // 导出按钮事件（仅超级管理员可见）
            $('#exportBtn').on('click', function() {
                // 导出产品明细表格为 Excel
                if (typeof XLSX === 'undefined') {
                    layer.msg('导出功能需要加载 XLSX 库，请刷新页面重试', { icon: 2 });
                    return;
                }
                
                // 获取表格数据
                var tableData = [];
                var headers = ['产品名称', '产品经理', '规格型号', '单位', '数量', '销售单价', '销售价合计', '进价合计', '子项利润', '行备注'];
                tableData.push(headers);
                
                $('#productTableBody tr').each(function() {
                    var row = [];
                    $(this).find('td').each(function(index) {
                        if (index < 10) { // 只取前10列
                            var $select = $(this).find('select');
                            var $input = $(this).find('input');
                            if ($select.length > 0) {
                                // 获取选中的选项文本
                                var selectedText = $select.find('option:selected').text();
                                row.push(selectedText || '');
                            } else if ($input.length > 0) {
                                row.push($input.val() || '');
                            } else {
                                row.push($(this).text().trim() || '');
                            }
                        }
                    });
                    if (row.length > 0) {
                        tableData.push(row);
                    }
                });
                
                // 创建工作簿
                var wb = XLSX.utils.book_new();
                var ws = XLSX.utils.aoa_to_sheet(tableData);
                
                // 设置列宽
                ws['!cols'] = [
                    { wch: 20 }, { wch: 15 }, { wch: 20 }, { wch: 10 }, 
                    { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, 
                    { wch: 15 }, { wch: 20 }
                ];
                
                // 添加工作表
                XLSX.utils.book_append_sheet(wb, ws, '产品明细');
                
                // 生成文件名
                var fileName = '订单产品明细_' + ($('#order_no').val() || '订单') + '_' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '.xlsx';
                
                // 导出文件
                XLSX.writeFile(wb, fileName);
                
                layer.msg('导出成功！', { icon: 1, time: 1500 });
            });

            // 【修改】详情页全量只读逻辑（优化版）
            (function lockAllWhenReady(){
                var $ = layui.$;
                var form = layui.form;

                // 1) 输入框与文本域：统一 readonly（已在 HTML 中添加，这里确保所有都只读）
                $('input:not([type=hidden]):not([readonly]), textarea:not([readonly])').each(function(){
                    $(this).attr('readonly', true);
                    // 避免日期/时间控件弹窗
                    $(this).off('click.laydate focus.laydate');
                });

                // 2) 禁止日期控件手动触发（详情页不允许弹窗）
                $('#orderTime').attr('readonly', true).off('click focus').on('click focus', function(e) {
                    e.preventDefault();
                    return false;
                });

                // 3) 产品明细表格里的所有输入/下拉也一并锁定（已在 HTML 中添加，这里确保）
                $('#productTableBody').find('input:not([readonly]), textarea:not([readonly])').attr('readonly', true);
                $('#productTableBody').find('select:not([disabled])').attr('disabled', true);
                form.render('select');
                $('#productTableBody').find('.layui-form-select').addClass('layui-disabled');

                // 4) 确保所有 select 都已禁用（包括产品明细表格外的）
                $('select:not([disabled])').attr('disabled', true);
                form.render('select');
                $('.layui-form-select').addClass('layui-disabled');
                fixSelectAlign(); // 调整对齐

                // 5) 禁用 xm-select 协同人组件（已在上面处理，这里做二次确认）
                setTimeout(function() {
                    try {
                        var collabIns = xmSelect.get('#collaboratorSelect', true);
                        if (collabIns && collabIns.update) {
                            collabIns.update({ disabled: true });
                        }
                        $('#collaboratorSelect').addClass('xm-select-disabled');
                    } catch(e) {
                        // 忽略错误
                    }
                }, 300);

                // 6) 防止任何表单提交
                $('form.layui-form').on('submit', function(e) {
                    e.preventDefault();
                    return false;
                });

                // 7) 根据凭证豁免条件更新凭证展示块的显示/隐藏
                updateVoucherUI();

            })();
        });
    </script>
</body>
</html>
