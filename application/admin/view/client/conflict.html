{include file="common/head"/}
<style>
  .filtrate-warp {
    margin-bottom: 10px;
  }

  .filtrate-warp .title {
    padding: 5px 12px 7px 12px;
    font-size: 14px;
    font-weight: normal;
    text-align: left;
    cursor: pointer;
    width: 90px;
    background-color: transparent !important;
    color: black !important;
  }

  .filtrate-warp .title:hover {
    color: black;
  }

  .filtrate-warp .flag {
    padding: 6px 12px 6px 12px;
    cursor: pointer;
  }

  .filtrate-warp .flag:hover {
    color: black;
  }

  .filtrate-warp .layui-badge:hover {
    color: white !important;
  }

  .box-search {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .input-box {
    width: 100% !important;
  }

  /* 响应式样式 */
  .pc-only {
    display: block;
  }

  .m-only {
    display: none;
  }

  /* 手机端样式 */
  @media screen and (max-width: 768px) {
    .pc-only {
      display: none;
    }

    .m-only {
      display: block;
    }

    /* 表单在手机端全宽 */
    .layui-form-item .layui-inline {
      display: block;
      width: 100%;
      margin-right: 0;
    }

    .layui-form-item .layui-input-inline {
      width: 100%;
    }

    .layui-form-item .layui-inline.box-search {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .layui-form-item .layui-inline.box-search .layui-input-inline {
      width: 100%;
    }

    .layui-form-item .layui-inline.box-search > div:last-child {
      width: 100%;
      float: none;
    }

    .layui-form-item .layui-inline.box-search button {
      width: 100%;
    }

    /* 卡片样式 */
    .m-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #e8e8e8;
    }

    .m-row {
      display: flex;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
      flex-wrap: wrap;
    }

    .m-row:last-child {
      border-bottom: none;
    }

    .m-k {
      font-weight: 600;
      color: #666;
      min-width: 80px;
      font-size: 14px;
      margin-right: 10px;
    }

    .m-v {
      flex: 1;
      color: #333;
      font-size: 14px;
      word-break: break-all;
      line-height: 1.6;
    }

    .m-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #1890ff;
      color: #fff;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 5px;
    }

    .m-empty {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 14px;
    }
  }
</style>
</head>

<body class="skin-<?php if(!empty($_COOKIE['skin'])){echo $_COOKIE['skin'];}else{echo '0';setcookie('skin','0');}?>">
  <div class="admin-main layui-anim layui-anim-upbit">
    <a href="javascript:window.history.back(-1)" class="layui-btn layui-btn-primary">返回上一页</a>
    <fieldset class="layui-elem-field ">
      <legend>客户冲突查询</legend>
      <div class="layui-card" style="box-shadow: none;margin-top: 10px">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto"
          style="border-bottom: transparent;height: auto">

          <div class="layui-form-item" style="text-align: left;padding-left: 20px;">
            <div class="layui-inline  box-search">
              <label class="layui-form-label"></label>
              <div class="layui-input-inline input-box">
                <input type="text" id="keyword" name="keyword" placeholder="输入客户名称/手机号/whatsapp/邮箱" autocomplete="off"
                  value="{$keyword}" class="layui-input">
              </div>
              <div class="layui-inline" style="float: right;">
                <button class="layui-btn layuiadmin-btn-list" lay-submit="" lay-filter="search">
                  <i class="layui-icon layui-icon-search layuiadmin-button-btn" style="vertical-align: sub;"></i>查询数据
                </button>
              </div>
            </div>

          </div>
    </fieldset>
    
    <!-- PC端表格 -->
    <div class="pc-only">
      <table class="layui-table" id="table-list" lay-filter="table-list"></table>
    </div>
    
    <!-- 手机端卡片列表 -->
    <div class="m-only" id="mobile-list">
      <div class="m-empty">暂无数据</div>
    </div>
  </div>

  {include file="common/foot"/}
  <script>
    layui.use(['table', 'form', 'layer'], function () {
      var table = layui.table;
      var form = layui.form;
      var $ = layui.$;
      var layer = layui.layer;

      /* ===== 渲染手机端卡片列表 ===== */
      function renderMobileList(data) {
        var $mobileList = $('#mobile-list');
        if (!data || data.length === 0) {
          $mobileList.html('<div class="m-empty">暂无数据</div>');
          return;
        }
        
        var html = '';
        data.forEach(function(item) {
          var prUser = (item.pr_gh_type && item.pr_gh_type.trim() !== '') ? item.pr_gh_type : (item.pr_user || '—');
          html += '<div class="m-card">';
          html += '<div class="m-row"><span class="m-k">客户名称：</span><span class="m-v">' + (item.kh_name || '—') + '</span></div>';
          html += '<div class="m-row"><span class="m-k">客户ID：</span><span class="m-v">' + (item.id || '—') + '</span></div>';
          html += '<div class="m-row"><span class="m-k">电话：</span><span class="m-v">' + (item.main_phone || '—') + '</span></div>';
          var assist = (item.assist_phone !== null && item.assist_phone !== undefined && String(item.assist_phone).trim() !== '') ? item.assist_phone : '—';
          html += '<div class="m-row"><span class="m-k">辅助电话：</span><span class="m-v">' + assist + '</span></div>';
          html += '<div class="m-row"><span class="m-k">所属渠道：</span><span class="m-v">' + (item.channel_name || '—') + '</span></div>';
          html += '<div class="m-row"><span class="m-k">运营端口：</span><span class="m-v">' + (item.port_name || '—') + '</span></div>';
          html += '<div class="m-row"><span class="m-k">客户归属人：</span><span class="m-v">' + prUser + '</span></div>';
          html += '<div class="m-row"><span class="m-k">添加时间：</span><span class="m-v">' + (item.at_time || '—') + '</span></div>';
          if (item.repeat_info) {
            html += '<div class="m-row"><span class="m-k">重复类型：</span><span class="m-v"><span class="m-badge">' + item.repeat_info + '</span></span></div>';
          }
          html += '</div>';
        });
        $mobileList.html(html);
      }

      /* ===== ① 首次渲染：本地数据模式，data 为空数组 ===== */
      var tableIns = table.render({
        elem  : '#table-list',
        data  : [],          // 先不给 url，保持本地模式
        page  : true,
        limit : 10,
        limits: [10, 20, 50],
        cols  : [[
          { checkbox: true, fixed: true },
          { field: 'id',        title: '客户id'    },
          { field: 'kh_name',   title: '客户名称'  },
          { field: 'main_phone', title: '电话',
            templet: function (res) { return res.main_phone || '—' }
          },
          { field: 'assist_phone', title: '辅助电话',
            templet: function (res) { 
              return (res.assist_phone !== null && res.assist_phone !== undefined && String(res.assist_phone).trim() !== '') ? res.assist_phone : '—';
            }
          },
          { field: 'channel_name', title: '所属渠道',
            templet: function (res) { return res.channel_name || '—' }
          },
          { field: 'port_name', title: '运营端口',
            templet: function (res) { return res.port_name || '—' }
          },
          { field: 'pr_user',   title: '客户归属人',
            templet: function (res) {
              return res.pr_gh_type && res.pr_gh_type.trim() !== ''
                     ? res.pr_gh_type
                     : (res.pr_user || '—');
            }
          },
          { field: 'at_time', title: '添加时间' },
          { field: 'repeat_info', title: '重复类型',
            templet: function (res) { return res.repeat_info || '' }
          },
          // { field: 'id', title: '操作',
          //   templet: function (res) {
          //     var current = "<?php echo session('username'); ?>";
          //     return (res.pr_user && res.pr_user === current)
          //            ? '<a href="<?php echo url("admin/client/edit"); ?>?id=' + res.id +
          //              '" class="layui-btn layui-btn-xs">编辑</a>'
          //            : '';
          //   }
          // }
        ]],
        done: function(res, curr, count) {
          // 渲染手机端卡片列表
          renderMobileList(res.data || []);
        }
      });

        
        
   
    /* ===== ② 表单提交：发起查重任务 ===== */
      form.on('submit(search)', function (data) {
        var keyword = data.field.keyword.trim();
        if (!keyword) {
          layer.msg('请输入搜索关键词', { icon: 5 });
          return false;
        }
    
        // 创建查重任务
        $.post("{:url('admin/client/conflict')}", { keyword: keyword }, function (res) {
          if (res.code !== 0) {
            layer.msg(res.msg || '提交查重任务失败', { icon: 5 });
            return;
          }
    
          var taskId      = res.task_id;
          var loadingIdx  = layer.msg('正在查重，请稍候…', {
                            icon: 16, shade: 0.3, time: false });
    
        //   var timer = setInterval(function () {
        //     $.post("{:url('admin/client/getConflictResult')}", { task_id: taskId }, function (res2) {
    
        //       if (res2.code === 202) return;               // 仍在处理 → 继续轮询
    
        //       clearInterval(timer);                        // 不管成功失败都停轮询
        //       layer.close(loadingIdx);
    
        //       if (res2.code !== 0) {                       // 失败
        //         layer.msg(res2.msg || '查重失败', { icon: 5 });
        //         return;
        //       }
    
        //       /* ===== ③ 结果到手：切换到本地数据模式并刷新 ===== */
        //       tableIns.reload({
        //         url  : '',           // ***关键：清空 url，保持本地模式***
        //         data : res2.data,    // 直接塞入返回数组
        //         page : { curr: 1 }   // 回第一页
        //       });
        //     });
        //   }, 1000);
        
        var timer = setInterval(function () {
          $.post("{:url('admin/client/getConflictResult')}", { task_id: taskId }, function (res2) {
        
            if (res2.code === 202) return; // 正在处理 → 继续轮询
        
            clearInterval(timer);          // 停止轮询
            layer.close(loadingIdx);       // 关闭加载提示
        
            if (res2.code === 404) {
              layer.msg(res2.msg || '查重失败，请再次尝试搜索', { icon: 5 });
              tableIns.reload({
                url  : '',
                data : [],
                page : { curr: 1 },
                done: function(res, curr, count) {
                  // 渲染手机端卡片列表
                  renderMobileList([]);
                }
              });
              return;
            }
        
            if (res2.code !== 0) {
              layer.msg(res2.msg || '查重失败', { icon: 5 });
              return;
            }
        
            // 查重成功，加载结果数据
            tableIns.reload({
              url  : '',
              data : res2.data || [],
              page : { curr: 1 },
              done: function(res, curr, count) {
                // 渲染手机端卡片列表
                renderMobileList(res.data || []);
              }
            });
          });
        }, 1000);

        
        
          
        });
    
        return false; // 禁止表单默认提交
      });      
            

        setTimeout(function () {
            var params = new URLSearchParams(window.location.search);
            var keyword = params.get('keyword');
            if (keyword) {
                $('input[name="keyword"]').val(keyword); // 自动填充
                $('button[lay-filter="search"]').trigger('click'); // 模拟点击触发查重
            }
        }, 100);        
            

      $('#keyword').on('keypress', function (e) {
        if (e.keyCode === 13) { // 回车键的 keyCode 是 13
          $('button[lay-filter="search"]').trigger('click'); // 触发搜索按钮点击事件
        }
      });
    });
  </script>
</body>

</html>